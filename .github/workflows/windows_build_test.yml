name: Windows Build/Test

on:
  # allows us to run workflows manually
  workflow_dispatch:
  push:
    branches:
      - main

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  BuildTest:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - { icon: 'â¬›', sys: mingw32 }
          - { icon: 'ðŸŸ¦', sys: mingw64 }
          - { icon: 'ðŸŸ¨', sys: ucrt64  }
          - { icon: 'ðŸŸ§', sys: clang64 }
    name: ${{ matrix.icon }} MSYS2-${{ matrix.sys }}
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: '${{ matrix.icon }} Setup MSYS2'
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{matrix.sys}}
          update: true
          install: >-
            base-devel
            git
          pacboy: >-
            toolchain:p
            cmake:p

      - name: Set git to use LF
        run: |
          git config --global core.autocrlf input

      - name: Build and Install HDF5
        run: |
          cd $GITHUB_WORKSPACE
          git clone --depth 1 https://github.com/HDFGroup/hdf5.git -b develop
          cd hdf5
          mkdir build
          cd build
          cmake .. \
            -C ../config/cmake/cacheinit.cmake \
            -G "Ninja" \
            -DCMAKE_INSTALL_PREFIX=/c/HDF5 \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_TOOLCHAIN_FILE="" \
            -DHDF5_GENERATE_HEADERS=OFF \
            -DHDF5_ENABLE_ALL_WARNINGS=ON \
            -DHDF5_ENABLE_PARALLEL=OFF \
            -DHDF5_BUILD_CPP_LIB=OFF \
            -DHDF5_BUILD_FORTRAN=OFF \
            -DHDF5_BUILD_JAVA=OFF \
            -DHDF5_BUILD_DOC=OFF \
            -DLIBAEC_USE_LOCALCONTENT=OFF \
            -DZLIB_USE_LOCALCONTENT=OFF \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release
          cmake --install . --config Release

      - name: Setup Eigen3
        run: |
          cd $GITHUB_WORKSPACE
          git clone --depth 1 https://gitlab.com/libeigen/eigen.git -b 3.4.0
          echo "EIGEN3_ROOT=$GITHUB_WORKSPACE/eigen" >> $GITHUB_ENV

      - name: Build and Install MOAB
        run: |
          cd $GITHUB_WORKSPACE
          git clone --depth 1 https://bitbucket.org/fathomteam/moab -b 5.5.1
          cd moab
          mkdir build
          cd build
          cmake .. \
            -G "Ninja" \
            -DCMAKE_INSTALL_PREFIX=/c/moab \
            -DBUILD_SHARED_LIBS=OFF \
            -DENABLE_BLASLAPACK=OFF \
            -DENABLE_FORTRAN=OFF \
            -DENABLE_IMESH=OFF \
            -DENABLE_TESTING=OFF \
            -DENABLE_HDF5=ON \
            -DHDF5_ROOT=/c/HDF5 \
            -DEIGEN3_DIR=$EIGEN3_ROOT \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release
          cmake --install . --config Release
